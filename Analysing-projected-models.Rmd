---
title: "Analysing-projected-models"
author: "Gerardo Mart√≠n"
date: "2/10/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=F, message=FALSE}
library(raster); library(ggplot2);library(reshape); library(foreach); library(data.table)
```

```{r}
incid.data <- readRDS("Data-objects/Incidence models data-Apr2020.rds")
proj.files <- list.files("Incidence-projections", "rds", full.names = T)
projections <- lapply(proj.files, readRDS)
```

```{r}
scenarios <- substr(proj.files, 34, nchar(proj.files) - 4)

med.projs <- lapply(projections, function(x){
      d <- foreach(i = seq_along(x), .combine = rbind) %do% {colMeans(x[[i]])}
      d <- data.frame(d)
      d$year <- 2010:2050
      return(d)
})
med.projs <- lapply(seq_along(med.projs), 
       function(x){
             med.projs[[x]]$scenario <- scenarios[x]
             return(med.projs[[x]])
             })
med.projs.df <- rbindlist(med.projs)
med.projs.df$scen <- med.projs.df$scenario
```


```{r}
library(ggplot2)
env.time <-  ggplot(med.projs.df) +   
      geom_ribbon(aes(x = year, ymin = env.025, ymax = env.97, fill = scen), alpha = 0.05) +
      geom_point(aes(x = year, y = env.med, colour = scen), size = 0.25) +
      geom_line(aes(x = year, y = env.med, colour = scen), size = 0.25, linetype = "dotted") +
      geom_hline(yintercept = mean(incid.data$envenomings), colour = "grey50", linetype = "dashed") + 
      geom_smooth(aes(x = year, y = env.med, colour = scen, fill = scen), alpha = 0.2, size = 0.75, method = "lm") +
      labs(x = "Year", y = "Envenoming incidence", colour = "Scenario", fill = "Scenario") +
   theme_light() + 
   theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

env.time
```

```{r}
decline.model <- lm(env.med ~ 0 + scen + scen : year, data = med.projs.df)
sum.mod <- summary(decline.model) 
```

```{r fig.height=4, fig.width=6}
rates <- data.frame(sum.mod$coefficients)

rates.df <- rates[8:14,]
rates.df$proj <- c("SSP1", 
                   "SSP2 CNRM-CM5", "SSP2 GFDL-CM3", "SSP2 MPI-ESM-LR", 
                   "SSP5 CNRM-CM5", "SSP5 GFDL-CM3", "SSP5 MPI-ESM-LR")
rates.df$signif <- as.factor(ifelse(rates.df$Pr...t.. > 0.05, 0, 1))
rates.df$SSP <- as.factor(substr(rates.df$proj, 1, 4))
```


```{r fig.height=4, fig.width=2}
rates.plot <- ggplot(rates.df) + geom_boxplot(aes(x = 1, y = Estimate)) + 
   geom_point(aes(x = 1, y = Estimate, colour = proj, shape = signif ), size = 3, position = position_dodge(0.3))+
   scale_shape_manual(values = c(4, 20)) +
   geom_linerange(aes(x = 1, ymin = Estimate - Std..Error, ymax = Estimate + Std..Error, colour = proj), position = position_dodge(0.3)) +
   labs(colour = "Scenario", y = "Absolute incidence change per year",
        x = "") + 
   theme(axis.text.x = element_text(size = 0),
         legend.position = "none") 
rates.plot
```

```{r}
med.projs.df$year[1]

scen <- levels(as.factor(med.projs.df$scen))

new.data.2050 <- expand.grid(scen = scen, year = 2050)
new.data.2010 <- expand.grid(scen = scen, year = 2010)

preds.2050 <- predict(decline.model, newdata = new.data.2050)
preds.2010 <- predict(decline.model, newdata = new.data.2010)

Percent.decline <- (preds.2010-preds.2050)/mean(incid.data$envenomings) * 100
Percent.decline
rates.df$Percent.decline <- Percent.decline * (-1)
```

```{r fig.height=4, fig.width=3}
percent.plot <- ggplot(rates.df) + geom_bar(aes(x = proj, y = Percent.decline*(-1), colour = proj, fill = proj),
                                            stat = "identity", alpha = 0.5)+
   scale_shape_manual(values = c(4, 20)) +
   labs(colour = "Scenario", y = "Percent change per year",
        x = "") + 
   theme(axis.text.x = element_text(size = 0),
         legend.position = "none") 
percent.plot
```

```{r fig.height=6, fig.width=12}
source("Random-functions/multiplot.R")

multiplot(rates.plot, env.time, layout = matrix(c(1, 2, 2, 2, 2, 2), ncol = 6))
dir.create("Plots")
pdf("Plots/Evenoming-change.pdf", width = 12, height = 6)
multiplot(rates.plot, env.time, layout = matrix(c(1, 2, 2, 2, 2, 2), ncol = 6))
dev.off()
```
# Estimate pixel-wise rate of change

```{r}
env.changes <- lapply(projections, function(x){lapply(x, function(x1){x1$env.med})})
env.changes <- lapply(env.changes, function(x){
   foreach(i = seq_along(x), .combine = cbind) %do% {
      x[[i]]
   }
})

change.models <- lapply(env.changes, function(x){
   foreach(i = 1:nrow(x), .combine = rbind) %do% {
      df <- data.frame(env <- x[i, ], time = 1:41)
      model <- lm(env ~ time, data = df)
      r2 <- summary(model)$adj.r.squared
      P <- summary(model)$coefficients[2, 4]
      return(c(intercept = model$coefficients["(Intercept)"],
               rate = model$coefficients["time"], 
               P = P, r2 = r2))
   }
})

ch.mods <- foreach(i = 1:7, .combine = rbind) %do% {
   rate <- change.models[[i]][, 2]
   intercept<- change.models[[i]][, 1]
   P <- change.models[[i]][, 2]
   r2 <- change.models[[i]][, 3]
   scen <- scenarios[i]
   return(data.frame(x = incid.data$x,
                     y = incid.data$y,
                     intercept = intercept,
                     rate = rate,
                     P = P,
                     r2 = r2,
                     scenario = scen))
}
```


```{r fig.height=15, fig.width=3}
library(viridis)

ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = rate)) + 
   facet_grid(scenario ~ 1) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = (inferno(100))) +
   labs(fill = "Annual \n rate") +
   theme_light()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_text(size = 6),
         legend.text = element_text(angle = 45, vjust = 0.5),
         legend.title = element_text(size = 14),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_blank())

pdf("Plots/Spatial-rates.of change.pdf", width = 3, height = 15)
ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = rate)) + 
   facet_grid(scenario ~ 1) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = (inferno(100))) +
   labs(fill = "") +
   theme_light()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_text(size = 6),
         legend.text = element_text(angle = 45, vjust = 0.5),
         legend.title = element_text(size = 14),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_blank())
dev.off()
```

```{r fig.height=15, fig.width=3}
ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = r2)) + 
   facet_grid(scenario ~ 1) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = (inferno(100))) +
   labs(fill = expression(italic(R)^2)) +
   theme_light()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_text(size = 6),
         legend.text = element_text(angle = 45, vjust = 0.5),
         legend.title = element_text(size = 14),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_text(size = 12))

ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = P)) + 
   facet_grid(scenario ~ 1) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = (inferno(100))) +
   labs(fill = expression(italic(P))) +
   theme_light()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_blank(),
         legend.text = element_text(angle = 45, vjust = 0.5),
         legend.title = element_text(size = 14),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_text(size = 12))

pdf("Plots/Spatial-r2.pdf", width = 3, height = 15)
ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = r2)) + 
   facet_grid(scenario ~ 1) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = (inferno(100))) +
   labs(fill = expression(italic(R)^2)) +
   theme_light()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_blank(),
         axis.title.y = element_blank(),
         legend.text = element_text(angle = 45, vjust = 0.5),
         legend.title = element_text(size = 14),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_text(size = 12))
dev.off()

```

# Absolute change between first and last time

```{r}
total.changes <- ch.mods$rate/rep(incid.data$envenomings, 7)*100
tot.2010 <- ch.mods$intercept + ch.mods$rate
tot.2050 <- ch.mods$intercept + ch.mods$rate*41
ch.mods$env.2010 <- tot.2010
ch.mods$env.2050 <- tot.2050
ch.mods$env.change <- with(ch.mods, env.2050/env.2010-env.2010/env.2010)*100

library(dplyr)
per.change <- ch.mods %>% group_by(scenario) %>% summarise(env.change = mean(na.omit(env.change)), env.err = sd(na.omit(env.change)))
```

```{r fig.height = 6, fig.width=9}
jet.colours <- colorRampPalette(c("navyblue", "royalblue4", "deepskyblue3", "yellow2", "darkorange", "red3", "#7F0000"))

ch.plot <- ggplot(ch.mods) + geom_raster(aes(x = x, y = y, fill = env.change)) + 
   facet_grid(1 ~ scenario) + coord_fixed(ratio = 1) + 
   scale_fill_gradientn(colours = jet.colours(100), 
                        breaks = c(-100, -50, 0, 50, 100),
                        limits = c(-105, 105)) +
   labs(title = "Envenoming incidence change by 2050", x = "", y = "", fill = "%") +
   theme_light()+
   theme(legend.position = "right",
         axis.text.x = element_blank(),
         axis.text.y = element_text(size = 6),
         axis.title.y =  element_blank(),
         legend.text = element_text(vjust = 0.5, size = 8),
         legend.title = element_text(size = 10),
         strip.text.x = element_text(size = 7),
         strip.text.y = element_blank(),
         plot.title = element_text(hjust = 0.5))

per.ch.plot <- ggplot(per.change) + geom_bar(aes(x = scenario, y = env.change, colour = scenario), stat = "identity", alpha = 0.5) +
    labs(x = "", y = "Average % change") +
    theme(axis.text.x = element_text(vjust = 0.5, size = 6),
          axis.text.y = element_text(size = 8),
          axis.title.y = element_text(size = 10),
          legend.position = "none")

per.ch.plot.2 <- ggplot(ch.mods) + geom_violin(aes(x = scenario, y = env.change, colour = scenario), alpha = 0.5) +
    geom_boxplot(aes(x = scenario, y = env.change, fill = scenario, colour = scenario), alpha = 0.1) +
    labs(x = "", y = "% change") + 
    theme(axis.text.x = element_text(vjust = 0.5, size = 6),
          axis.text.y = element_text(size = 8),
          axis.title.y = element_text(size = 10),
          legend.position = "none")

multiplot(ch.plot, per.ch.plot, cols = 1,  layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
multiplot(ch.plot, per.ch.plot.2, cols = 1,  layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
```


```{r}
pdf("Plots/Total-change.pdf", width = 9, height = 6)
multiplot(ch.plot, per.ch.plot, cols = 1,  layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
dev.off()

pdf("Plots/Total-change-2.pdf", width = 9, height = 6)
multiplot(ch.plot, per.ch.plot.2, cols = 1,  layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
dev.off()
```


# SSPs and latitude

Summarise by latitude and scenario, consider averaged ssp along longitude and envenoming only, then create hovmoller plot of incidence change through time

```{r}
library(dplyr)
library(data.table)
incid.data <- readRDS("Data-objects/Incidence models data-Apr2020.rds")

SSP <- c("SSP1", rep("SSP2", 3),
                 rep("SSP5", 3))

projs.df <- projections

for(i in seq_along(projs.df)){
   for(j in seq_along(projs.df[[i]])){
      projs.df[[i]][[j]]$year <- c(2010:2050)[j]
      projs.df[[i]][[j]]$scenario <- rates.df$proj[i]
      projs.df[[i]][[j]]$SSP <- SSP[i]
      projs.df[[i]][[j]] <- cbind(incid.data[, c("x", "y")], projs.df[[i]][[j]])
   }
   projs.df[[i]] <- rbindlist(projs.df[[i]])
}
projs.df <- rbindlist(projs.df)
```

```{r}
projs.df.sum <- projs.df %>% group_by(x, SSP, year) %>% summarise(
   sb.med = mean(sb.med),
   sb.025 = mean(sb.025),
   sb.97 = mean(sb.97),
   env.med = mean(env.med),
   env.025 = mean(env.025), 
   env.97 = mean(env.97),
   y = y)
```

```{r fig.height=6, fig.width=12}
library(viridis)

prob.env <- ggplot(projs.df.sum) + geom_tile(aes(x = year, y = y, fill = env.med/sb.med)) +
   facet_wrap(~ SSP) + 
   scale_fill_gradientn(colours = rev(inferno(50)), 
                        breaks = round(seq(0.45, 0.7, len = 5), 2),
                        limits = c(0.4, 0.75)) +
   labs(x = "Year", y = "Latitude", fill = paste0("Latitude-averaged", "\n",
                                                  "probability that bites", "\n", 
                                                  "result in envenoming")) + 
   theme_dark()+
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5),
         legend.text = element_text(angle = 45, vjust = 0.5))

prob.env

pdf("Plots/Probability-envenoming-LAT-TIME.pdf", width = 12, height = 6)
prob.env
dev.off()
```

# Identifying envenoming snake species

```{r}
spp <- c("Bungarus caeruleus", "Bungarus ceylonicus",
         "Daboia russelii", "Echis carinatus",
         "Hypnale spp.", "Naja naja",
         "Trimeresurus trigonocephalus")
proj.sn <- lapply(seq_along(projections), function(x){
   df <- rbindlist(lapply(ceiling(seq(1, 41, len = 4)), function(x1){
         return(data.frame(incid.data[, c("x", "y")], Species = spp[projections[[x]][[x1]]$snakes],
                           year = c(2010:2050)[x1]))
      }))
   df$scenario <- scenarios[x]
   return(df)
})

proj.sn.df <- rbindlist(proj.sn)
```

```{r fig.height=15, fig.width=6.5}
ggplot(proj.sn.df) + geom_tile(aes(x = x, y = y, fill = as.factor(Species))) + 
   facet_grid(scenario ~ year) + coord_fixed(ratio = 1) + 
   scale_fill_manual(values = rev(plasma(5))[2:5]) + 
   labs(fill = "") +
   theme_light() + 
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_text(size = 6),
         legend.text = element_text(face = "italic", size = 12),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_text(size = 12))
pdf("Plots/Snake-species-time-scenario.pdf", width = 6.5, height = 15)
ggplot(proj.sn.df) + geom_tile(aes(x = x, y = y, fill = Species)) + 
   facet_grid(scenario ~ year) + coord_fixed(ratio = 1) + 
   scale_fill_manual(values = rev(inferno(5))[2:5]) + 
   labs(fill = "") +
   theme_light() + 
   theme(legend.position = "bottom",
         axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
         axis.text.y = element_text(size = 6),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_text(size = 12),
         legend.text = element_text(face = "italic", size = 12))
dev.off()
```

## Binary changes

```{r}
bin.change <- subset(ch.mods, select = c("x", "y", "rate", "scenario"))
lev.scen <- levels(as.factor(bin.change$scenario))

bin.change.l <- lapply(lev.scen, function(x){bin.change[bin.change$scenario == x, -4]})

bin.change.wide <- cbind(bin.change.l[[1]][, c("x", "y")],
                              bin.change.l[[1]]$rate,
                              bin.change.l[[2]]$rate,
                              bin.change.l[[3]]$rate,
                              bin.change.l[[4]]$rate,
                              bin.change.l[[5]]$rate,
                              bin.change.l[[6]]$rate,
                              bin.change.l[[7]]$rate)
names(bin.change.wide) <- c("x", "y", lev.scen)
```

```{r}
bin.change.r <- rasterFromXYZ(bin.change.wide)

bin.ssp1 <- dropLayer(bin.change.r, i = 2:7)
bin.ssp2 <- dropLayer(bin.change.r, i = c(1, 5:7))
bin.ssp5 <- dropLayer(bin.change.r, i = c(1:4))

dec.ssp1 <- bin.ssp1 < 0
dec.ssp2 <- sum(bin.ssp2 < 0)
dec.ssp5 <- sum(bin.ssp5 < 0)

df.dec.ssp <- data.frame(rasterToPoints(stack(dec.ssp1, dec.ssp2, dec.ssp5)))
names(df.dec.ssp) <- c("x", "y", "SSP1", "SSP2", "SSP3")

```


```{r}
df.dec.ssp.long <- reshape2::melt(df.dec.ssp, id.vars = c("x", "y"))

dec.maps <- ggplot(df.dec.ssp.long) + geom_raster(aes(x = x, y = y, fill = as.factor(value))) +
    facet_grid(1~variable) + coord_fixed(ratio = 1) + 
    scale_fill_manual(values = (inferno(5)[c(1, 2, 3, 4)])) + 
    labs(fill = "") +
    theme_light() + 
    theme(legend.position = "right",
         axis.text.x = element_blank(),
         axis.title.x = element_blank(),
         axis.text.y = element_text(size = 6),
         strip.text.x = element_text(size = 12),
         strip.text.y = element_blank(),
         legend.text = element_text(face = "italic", size = 12))
```

```{r}
prop.0 <- c(cellStats(dec.ssp1==0, mean),
            cellStats(dec.ssp2==0, mean),
            cellStats(dec.ssp5==0, mean))
prop.1 <- c(cellStats(dec.ssp1==1, mean),
            cellStats(dec.ssp2==1, mean),
            cellStats(dec.ssp5==1, mean))
prop.2  <- c(cellStats(dec.ssp1==2, mean),
            cellStats(dec.ssp2==2, mean),
            cellStats(dec.ssp5==2, mean))
prop.3  <- c(cellStats(dec.ssp1==3, mean),
            cellStats(dec.ssp2==3, mean),
            cellStats(dec.ssp5==3, mean))
gcms <- rep(0:3, each = 3)
ssps <- rep(c("SSP1", "SSP2", "SSP3"), 4)

dec.prop <- data.frame(prop = c(prop.0, prop.1, prop.2, prop.3)*100,
                       gcms, SSP = ssps)

dec.prop.plot <- ggplot(dec.prop, aes(x = "", y = prop, fill = as.factor(gcms))) +
    geom_col() +
    coord_polar(theta = "y") +
    facet_grid(1~SSP) +
    scale_fill_manual(values = (inferno(5)[c(1, 2, 3, 4)])) +
    labs(x = "", y = "% Area") +
    theme_minimal() +
    theme(strip.text.x = element_blank(),
          strip.text.y = element_blank(),
          axis.ticks = element_blank(), 
          legend.position = "none")

```

```{r}
multiplot(dec.maps, dec.prop.plot, layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
pdf("Plots/Decrease-maps.pdf",width = 5.5, height = 6)
multiplot(dec.maps, dec.prop.plot, layout = matrix(c(1, 1, 1, 1, 1, 2, 2, 2), ncol = 1))
dev.off()
```


## Land cover change dynamics and envenoming change

```{r}
lc.files <- list.files("Land-cover-5km", "tif", full.names = T, recursive = T)

lc.r <- stack(lc.files)

#Correr y verificar estas
lc.tea <- reclassify(lc.r, cbind(from = c(-Inf, 4), to = c(4, 5), becomes = c(0, 1)))
lc.urban <- reclassify(lc.r, cbind(from = c(-Inf, 3, 4), to = c(3, 4, Inf), becomes = c(0, 1, 0)))
lc.agric <- reclassify(lc.r, cbind(from = c(-Inf, 2, 3), to = c(2, 3, Inf), becomes = c(0, 1, 0)))# lc.r == 3
lc.degraded <- reclassify(lc.r, cbind(from = c(-Inf, 1, 2), to = c(1, 2, Inf), becomes = c(0, 1, 0)))
lc.forest <- reclassify(lc.r, cbind(from = c(-Inf, 1), to = c(1, 5), becomes = c(1, 0)))

lc.urban.m <- cellStats(lc.urban, mean)
lc.tea.m <- cellStats(lc.tea, mean)
lc.agric.m <- cellStats(lc.agric, mean)
lc.degraded.m <- cellStats(lc.degraded, mean)
lc.forest.m <- cellStats(lc.forest, mean)
```

```{r}
med.projs.df$Urban <- lc.urban.m
med.projs.df$Tea <- lc.tea.m
med.projs.df$Agricultural <- lc.agric.m
med.projs.df$Degraded <- lc.degraded.m
med.projs.df$Forest <- lc.forest.m
```

```{r fig.height=5, fig.width=9}
ggplot(med.projs.df) + geom_point(aes(x = year, y = urban, colour = scenario)) +
    geom_path(aes(x = year, y = urban, colour = scenario),
              arrow = arrow(type = "closed", 
                          length = unit(0.1, "inches")),
              linetype = "dotted") +
    theme_light()

ggplot(med.projs.df) + geom_point(aes(x = year, y = forest, colour = scenario),
                                  size = 0.5) +
    geom_path(aes(x = year, y = forest, colour = scenario),
              arrow = arrow(type = "closed", 
                          length = unit(0.15, "inches"),
                          ends = "last"), size = 0.25) +
    theme_light()

ggplot(med.projs.df) + geom_point(aes(x = degraded, y = env.med, colour = scenario),
                                  size = 0.5) +
    geom_path(aes(x = degraded, y = env.med, colour = scenario),
              arrow = arrow(type = "closed", 
                          length = unit(0.15, "inches"),
                          ends = "last"), size = 0.25) +
    theme_light()
```

```{r fig.height=12, fig.width=3}
urb.for.plot <- ggplot(med.projs.df) + geom_point(aes(x = urban, y = forest, colour = env.med, size = env.med), 
                                                  alpha = 0.5) + 
    geom_path(aes(x = urban, y = forest),
                                 arrow = arrow(type = "closed", 
                          length = unit(0.15, "inches"),
                          ends = "first"), size = 0.25) +
    guides(size = "none") +
    scale_colour_gradientn(colours = (inferno(100))) +
    facet_grid(scenario~1) + 
    labs(x = "Urban cover", y = "Forest cover", colour = "Envenoming\n incidence", size = "") +
    theme(strip.text.x = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(angle = 45, vjust = 0.5))
```

```{r fig.height=12, fig.width=3}
agr.for.plot <- ggplot(med.projs.df) + geom_point(aes(x = agric, y = forest, colour = env.med, size = env.med), 
                                                  alpha = 0.5) + 
     geom_path(aes(x = agric, y = forest),
                                 arrow = arrow(type = "closed", 
                          length = unit(0.15, "inches"),
                          ends = "first"), size = 0.25) +
    guides(size = "none") +
    scale_colour_gradientn(colours = (inferno(100))) +
    facet_grid(scenario~1) + 
    labs(x = "Agricultural cover", y = "Forest cover", colour = "Envenoming\n incidence") +
    theme(strip.text.x = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(angle = 45, vjust = 0.5))
```

```{r  fig.height=12, fig.width=3}
urb.agric.plot <- ggplot(med.projs.df) + geom_point(aes(x = urban, y = agric, colour = env.med, size = env.med),
                                                    alpha = 0.5) + 
    geom_path(aes(x = urban, y = agric), arrow = arrow(type = "closed", 
                          length = unit(0.15, "inches"),
                          ends = "last"), size = 0.25) +  guides(size = "none") +
    scale_colour_gradientn(colours = (inferno(100))) +
    facet_grid(scenario~1) + 
    labs(x = "Urban cover", y = "Agricultural cover", colour = "Envenoming\n incidence") +
    theme(strip.text.x = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(angle = 45, vjust = 0.5))
```

```{r fig.height=12, fig.width=9}

multiplot(urb.for.plot, urb.agric.plot, agr.for.plot, layout = matrix(c(1, 2, 3), ncol = 3))

pdf("Plots/Evenoming-cover.pdf", width = 9, height = 12)
multiplot(urb.for.plot, urb.agric.plot, agr.for.plot, layout = matrix(c(1, 2, 3), ncol = 3))
dev.off()
```

```{r}
med.projs.df.1050 <- subset(med.projs.df, year %in% c(2010, 2050))
med.projs.df.2010 <- subset(med.projs.df, year == 2010, select = c("env.med", "Urban", "Tea", "Agricultural", "Degraded", "Forest"))
med.projs.df.2050 <- subset(med.projs.df, year == 2050, select = c("env.med", "Urban", "Tea", "Agricultural", "Degraded", "Forest"))
med.projs.df.dif <- (med.projs.df.2050 - med.projs.df.2010)*100
med.projs.df.dif$Decline <- rates.df$Percent.decline
med.projs.df.dif$Scenario <- med.projs.df.1050[med.projs.df.1050$year== 2010]$scenario

med.projs.dif.melt <- melt(med.projs.df.dif, measure.vars = c("Urban", "Tea", "Agricultural", "Degraded", "Forest"))
```

```{r fig.height=12, fig.width=5}
incid.lc.change <- ggplot(med.projs.dif.melt, aes(x = value, y = Decline,
                               label = Scenario)) + geom_point(aes(colour = Scenario)) +
    facet_grid(variable~1) + 
    geom_vline(xintercept = 0, linetype = 2, colour = "grey50") + 
    geom_text(nudge_y = 1,  size = 3) +
    labs(x = "% Land cover change", y = "% Envenoming incidence change") +
    theme(legend.position = "none")
pdf("Plots/Incidence-LC-change.pdf", width = 5, height = 12)
incid.lc.change
dev.off()
```


